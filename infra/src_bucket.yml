AWSTemplateFormatVersion: "2010-09-09"
Description: "Source Code Bucket"
Metadata: {}
Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
    Description: |
      Placeholder

Conditions: {}
Outputs:
  S3SourceCodeBucket:
    Description: Bucket containing zip files of source code
    Value: !Ref S3SourceCodeBucket
    Export:
      Name: S3SourceCodeBucket
  S3BucketLogsDomainName:
    Description: Domain Name of logs bucket
    Value: !GetAtt S3BucketLogs.DomainName
    Export:
      Name: S3BucketLogsDomainName
  S3BucketRootDomainName:
    Description: Domain Name of root bucket
    Value: !GetAtt S3BucketRoot.DomainName
    Export:
      Name: S3BucketRootDomainName
  S3BucketRoot:
    Description: Domain Name of logs bucket
    Value: !Ref S3BucketRoot
    Export:
      Name: S3BucketRoot
  S3BucketRootArn:
    Description: Domain Name of logs bucket
    Value: !GetAtt S3BucketRoot.Arn
    Export:
      Name: S3BucketRootArn

Resources:
  S3SourceCodeBucket:
    DeletionPolicy: Retain
    Type: "AWS::S3::Bucket"
    Properties:
      BucketName: !Sub "fitness-app-source-bucket-${Environment}"
      LoggingConfiguration: {}
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: "AES256"
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: OnlyKeep5Versions
            NoncurrentVersionExpiration:
              NewerNoncurrentVersions: 5
              NoncurrentDays: 1
            # Prefix: /functions
            Status: Enabled

  S3BucketLogs:
    DeletionPolicy: Retain
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "fitness-app-logs-bucket-${Environment}"
      # AccessControl: LogDeliveryWrite
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

  S3BucketRoot:
    DeletionPolicy: Retain
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "fitness-app-root-bucket-${Environment}"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LoggingConfiguration:
        DestinationBucketName: !Ref "S3BucketLogs"
        LogFilePrefix: "origin/"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
